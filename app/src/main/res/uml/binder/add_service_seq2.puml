@startuml
title
<font color=red size=16>系统服务注册流程二</font>

end title

header
<font color=red>Warning:</font>
Do not use for commercial purposes.
end header
'--------------------------------------------
participant service_manager.c as sm
participant binder.c as b
box kernel
participant binder.c as kb order 1
end box

[->sm:main
activate sm
sm->b:binder_open(\n/dev/binder,128*1024)
activate b
b->kb:open
activate kb
kb->kb:binder_open
return
deactivate kb
b->kb:mmap
activate kb
kb->kb:binder_mmap
return
deactivate kb
deactivate b
sm->b:binder_looper(\n<color red>svcmgr_handler</color>)
deactivate sm
activate b

create control binder_looper
b->binder_looper
activate binder_looper
binder_looper->kb:ioctl(\nBINDER_WRITE_READ,&bwr)
activate kb
kb->kb:binder_thread_read
activate kb
kb->kb:binder_wait_for_work
activate kb
kb->kb:prepare_to_wait(&thread_wait)
kb->kb:schedule
hnote over kb:等待队列开始睡眠
kb o<--]:<wake_up(&thread_wait)
hnote over kb:work来临唤醒队列
deactivate kb
kb->kb:binder_dequeue_work\n_head_ilocked
kb->kb:<build biner_transaction>
kb-->binder_looper:bwr
deactivate kb
binder_looper->binder_looper:binder_parse
activate binder_looper
binder_looper->sm:\n<color red>svcmgr_handler</color>
deactivate binder_looper
activate sm
sm->sm:doAddService
deactivate sm


right footer Generated by Yaoguang
@enduml